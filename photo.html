<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUMOS | Visual Narratives</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600&family=Manrope:wght@200;300;400&family=Playfair+Display:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://unpkg.com/gl-matrix@3.4.3/gl-matrix-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/studio-freight/lenis@1.0.29/bundled/lenis.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'void': '#050505',
                        'charcoal': '#0a0a0a',
                        'gold-accent': '#C5A059',
                        'glass': 'rgba(255, 255, 255, 0.03)'
                    },
                    fontFamily: {
                        'serif': ['"Playfair Display"', 'serif'],
                        'display': ['"Cinzel"', 'serif'],
                        'sans': ['"Manrope"', 'sans-serif'],
                    },
                    letterSpacing: {
                        'ultra': '0.25em',
                    }
                }
            }
        }
    </script>

    <style>
        /* --- GLOBAL RESET & CURSOR --- */
        * { cursor: none !important; }
        body {
            background-color: #050505;
            color: #e5e5e5;
            overflow-x: hidden;
        }

        .noise-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9000; opacity: 0.04;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        #cursor-dot {
            position: fixed; top: 0; left: 0; width: 8px; height: 8px; 
            background-color: #C5A059; border-radius: 50%; z-index: 9999; pointer-events: none;
            transform: translate(-50%, -50%);
        }
        
        #cursor-outline {
            position: fixed; top: 0; left: 0; width: 40px; height: 40px;
            border: 1px solid rgba(197, 160, 89, 0.4); border-radius: 50%;
            z-index: 9998; pointer-events: none; 
            transform: translate(-50%, -50%);
            transition: width 0.2s, height 0.2s, background-color 0.2s, border-color 0.2s;
        }
        
        body.hovering #cursor-outline {
            width: 60px; height: 60px;
            background-color: rgba(197, 160, 89, 0.05); border-color: transparent;
        }

        /* Scrollbar & Loader */
        ::-webkit-scrollbar { width: 0px; }
        html.lenis { height: auto; }
        #loader { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .loader-text { font-family: 'Cinzel', serif; font-size: 1.5rem; color: #C5A059; letter-spacing: 0.5em; }

        /* Infinite Menu (Hero WebGL) */
        .infinite-menu-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none; z-index: 20; width: 100%;
            mix-blend-mode: exclusion;
        }
        .face-title {
            font-family: 'Cinzel', serif; font-size: 5vw; color: #fff;
            text-transform: uppercase; letter-spacing: 0.05em;
        }
        .face-description {
            font-family: 'Playfair Display', serif; font-style: italic;
            color: #C5A059; letter-spacing: 0.1em; margin-top: 1rem;
        }
        #infinite-grid-menu-canvas {
            width: 100%; height: 100%; display: block; outline: none;
        }

        /* MASONRY GRID STYLES */
        .masonry-grid {
            column-count: 1;
            column-gap: 2rem;
        }
        @media (min-width: 768px) { .masonry-grid { column-count: 2; } }
        @media (min-width: 1024px) { .masonry-grid { column-count: 3; } }

        .masonry-item {
            break-inside: avoid;
            margin-bottom: 2rem;
            position: relative;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            /* Ensure visible by default */
            opacity: 1; 
            border: 1px solid rgba(255,255,255,0.05);
            background: #0a0a0a;
        }
        
        .masonry-item img {
            width: 100%;
            display: block;
            transition: transform 0.7s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .masonry-item:hover img {
            transform: scale(1.05);
        }

        .masonry-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.95), transparent 50%);
            opacity: 0;
            transition: opacity 0.4s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 2rem;
        }
        
        .masonry-item:hover .masonry-overlay {
            opacity: 1;
        }

        .overlay-title {
            transform: translateY(20px);
            transition: transform 0.4s ease 0.1s;
        }
        .masonry-item:hover .overlay-title {
            transform: translateY(0);
        }

        /* PROJECT MODAL */
        #project-modal {
            position: fixed; inset: 0; z-index: 8000;
            background-color: #050505; opacity: 0; pointer-events: none;
            display: flex; flex-direction: column;
            visibility: hidden;
            transition: opacity 0.6s cubic-bezier(0.16, 1, 0.3, 1), visibility 0.6s;
            overflow-y: auto; 
            scroll-behavior: smooth;
        }
        #project-modal.active { opacity: 1; pointer-events: auto; visibility: visible; }
        
        .modal-close-btn {
            position: fixed; top: 2rem; right: 2rem; z-index: 8001; cursor: pointer;
            mix-blend-mode: difference;
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 2rem;
            padding-bottom: 5rem;
        }
        @media(min-width: 768px) {
            .gallery-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* LIGHTBOX STYLES */
        #lightbox {
            position: fixed; inset: 0; z-index: 9000;
            background-color: rgba(5, 5, 5, 0.98);
            backdrop-filter: blur(15px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #lightbox.active {
            opacity: 1; pointer-events: auto;
        }
        
        #lightbox-img {
            max-width: 90vw; max-height: 90vh;
            object-fit: contain;
            transform: scale(0.95);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        #lightbox.active #lightbox-img {
            transform: scale(1);
        }
        
        .lightbox-close {
            position: absolute; top: 2rem; right: 2rem;
            color: white; cursor: pointer;
            transition: color 0.3s;
        }
        .lightbox-close:hover { color: #C5A059; }

        .text-roll span { display: inline-block; transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        .text-roll-item { display: inline-block; }
        .vignette { background: radial-gradient(circle, transparent 40%, #dfdfdf 110%); }
    </style>
</head>
<body class="antialiased selection:bg-gold-accent selection:text-black">

    <div class="noise-overlay"></div>
    <div id="cursor-dot"></div>
    <div id="cursor-outline"></div>

    <div id="loader">
        <div class="loader-text">
            <span class="inline-block opacity-0 translate-y-4" id="l-1">L</span>
            <span class="inline-block opacity-0 translate-y-4" id="l-2">U</span>
            <span class="inline-block opacity-0 translate-y-4" id="l-3">M</span>
            <span class="inline-block opacity-0 translate-y-4" id="l-4">O</span>
            <span class="inline-block opacity-0 translate-y-4" id="l-5">S</span>
        </div>
    </div>

    <nav class="fixed top-0 w-full p-8 z-50 flex justify-between items-center mix-blend-difference">
        <div class="text-xl font-display font-bold tracking-[0.3em] cursor-pointer hover-trigger text-white">LUMOS</div>
        <div class="hidden md:flex space-x-16 font-sans text-xs tracking-[0.2em] uppercase text-white/80">
            <a href="#work" class="text-roll hover-trigger block hover:text-gold-accent transition-colors" data-text="Work">Work</a>
            <a href="#about" class="text-roll hover-trigger block hover:text-gold-accent transition-colors" data-text="Artist">Artist</a>
            <a href="#contact" class="text-roll hover-trigger block hover:text-gold-accent transition-colors" data-text="Contact">Contact</a>
        </div>
        <button class="md:hidden hover-trigger text-white"><i data-lucide="menu" class="w-6 h-6"></i></button>
    </nav>

    <!-- HERO: Clean WebGL Sphere -->
    <header id="hero" class="relative h-screen w-full overflow-hidden bg-void vignette">
        <div id="webgl-error" style="display:none; position:absolute; top:10px; left:10px; color:red; z-index:9999;"></div>
        <canvas id="infinite-grid-menu-canvas" class="hover-trigger relative z-10 w-full h-full block opacity-100" style="touch-action: none;"></canvas>
        <div class="infinite-menu-overlay pointer-events-none">
            <h2 id="menu-title" class="face-title active">LOADING</h2>
            <p id="menu-desc" class="face-description active">Visual Narratives</p>
            <div id="menu-btn" class="mt-8 mx-auto w-12 h-12 border border-white/20 rounded-full flex items-center justify-center animate-bounce hover-trigger pointer-events-auto cursor-pointer">
                <i data-lucide="arrow-down" class="w-4 h-4 text-gold-accent"></i>
            </div>
        </div>
    </header>

    <!-- TRANSITION TEXT -->
    <section id="transition-text" class="relative py-40 bg-void flex flex-col items-center justify-center overflow-hidden z-30">
        <div class="max-w-[80vw] text-center z-10">
            <h2 class="text-5xl md:text-8xl font-display leading-[1.1] text-white mix-blend-difference">
                <div class="overflow-hidden"><span class="inline-block reveal-text translate-y-full opacity-0">VISUAL</span></div>
                <div class="overflow-hidden"><span class="inline-block reveal-text translate-y-full opacity-0 text-gold-accent font-serif italic pr-4">Symphony</span></div>
            </h2>
            <div class="h-[1px] w-24 bg-gold-accent mx-auto mt-12 mb-6 reveal-sub opacity-0"></div>
        </div>
    </section>

    <!-- PARALLAX GALLERY -->
    <div class="bg-void relative overflow-hidden z-20 border-t border-white/5">
        <section id="parallax-gallery" class="relative flex h-[50vh] gap-6 px-4 md:px-12 items-center justify-center overflow-hidden">
            <div id="gallery-fade-layer" class="absolute inset-0 bg-void z-20 pointer-events-none opacity-0"></div>
            <div class="parallax-col w-1/4 min-w-[200px] flex flex-col gap-8" data-offset="-250">
                <div class="w-full aspect-[3/4] rounded-[2px] overflow-hidden border border-white/10"><img src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?q=80&w=500" class="w-full h-full object-cover opacity-70 grayscale hover:grayscale-0 transition-all duration-1000"></div>
                <div class="w-full aspect-[3/4] rounded-[2px] overflow-hidden border border-white/10"><img src="https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?q=80&w=500" class="w-full h-full object-cover opacity-70 grayscale hover:grayscale-0 transition-all duration-1000"></div>
            </div>
            <div class="parallax-col w-1/4 min-w-[200px] flex flex-col gap-8" data-offset="150">
                <div class="w-full aspect-[3/4] rounded-[2px] overflow-hidden border border-white/10"><img src="https://images.unsplash.com/photo-1500917293891-ef795e70e1f6?q=80&w=500" class="w-full h-full object-cover opacity-80 hover:opacity-100 grayscale hover:grayscale-0 transition-all duration-1000"></div>
                <div class="w-full aspect-[3/4] rounded-[2px] overflow-hidden border border-white/10"><img src="https://images.unsplash.com/photo-1615715757401-f30e7b27b912?q=80&w=500" class="w-full h-full object-cover opacity-80 hover:opacity-100 grayscale hover:grayscale-0 transition-all duration-1000"></div>
            </div>
            <div class="parallax-col w-1/4 min-w-[200px] flex flex-col gap-8" data-offset="-100">
                <div class="w-full aspect-[3/4] rounded-[2px] overflow-hidden border border-white/10"><img src="https://images.unsplash.com/photo-1493863641943-9b68992a8d07?q=80&w=500" class="w-full h-full object-cover opacity-80 hover:opacity-100 grayscale hover:grayscale-0 transition-all duration-1000"></div>
                <div class="w-full aspect-[3/4] rounded-[2px] overflow-hidden border border-white/10"><img src="https://images.unsplash.com/photo-1516035069371-29a1b244cc32?q=80&w=500" class="w-full h-full object-cover opacity-70 grayscale hover:grayscale-0 transition-all duration-1000"></div>
            </div>
            <div class="parallax-col w-1/4 min-w-[200px] flex flex-col gap-8" data-offset="300">
                <div class="w-full aspect-[3/4] rounded-[2px] overflow-hidden border border-white/10"><img src="https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?q=80&w=500" class="w-full h-full object-cover opacity-70 grayscale hover:grayscale-0 transition-all duration-1000"></div>
                <div class="w-full aspect-[3/4] rounded-[2px] overflow-hidden border border-white/10"><img src="https://images.unsplash.com/photo-1515523110800-9415d13b84a8?q=80&w=500" class="w-full h-full object-cover opacity-70 grayscale hover:grayscale-0 transition-all duration-1000"></div>
            </div>
        </section>

        <!-- ADDED MARGIN TOP 120PX -->
        <section class="relative min-h-[40vh] flex flex-col items-center justify-center text-center px-6 bg-void z-20 mt-[120px]">
            <div class="max-w-5xl">
                <h3 class="text-3xl md:text-5xl font-display leading-relaxed text-white/90">
                    <span class="font-serif italic text-gold-accent mr-4">"</span>Photography is the art of<br>
                    <span class="text-white">frozen time.</span><span class="font-serif italic text-gold-accent ml-4">"</span>
                </h3>
            </div>
        </section>
    </div>

    <!-- FEATURED PROJECTS (PINTEREST STYLE MASONRY) -->
    <section id="work" class="relative py-32 bg-void z-20 border-t border-white/5">
        <div class="max-w-7xl mx-auto mb-24 px-6 md:px-12 flex justify-between items-end">
            <h2 class="text-4xl md:text-6xl font-display text-white">Selected<br><span class="font-serif italic text-gold-accent">Works</span></h2>
        </div>

        <div class="max-w-[1600px] mx-auto px-6 md:px-12">
            <div class="masonry-grid" id="projects-masonry"></div>
        </div>
    </section>

    <!-- PROJECT MODAL -->
    <div id="project-modal" class="overflow-x-hidden">
        <div class="modal-close-btn hover-trigger p-4 flex items-center gap-2 group sticky top-8 right-8 z-50 self-end">
            <span class="font-mono text-xs text-white group-hover:text-gold-accent transition-colors bg-black/50 px-2 py-1 rounded backdrop-blur-sm">CLOSE</span>
            <div class="bg-black/50 p-2 rounded-full backdrop-blur-sm">
                <i data-lucide="x" class="w-6 h-6 text-white group-hover:text-gold-accent transition-colors"></i>
            </div>
        </div>
        
        <div class="relative w-full bg-void pb-32">
            <div class="h-[80vh] w-full relative overflow-hidden">
                <img id="modal-hero-img" src="" class="w-full h-full object-cover opacity-90">
                <div class="absolute inset-0 bg-gradient-to-t from-void via-void/20 to-transparent"></div>
                <div class="absolute bottom-16 left-6 md:left-24 max-w-4xl">
                    <h2 id="modal-title" class="text-5xl md:text-8xl font-display text-white mb-4 leading-none drop-shadow-2xl">Title</h2>
                    <p id="modal-subtitle" class="font-serif text-gold-accent italic text-2xl drop-shadow-lg">Subtitle</p>
                </div>
            </div>

            <div class="max-w-3xl mx-auto px-6 py-24 text-center">
                <div class="w-[1px] h-24 bg-gold-accent/50 mx-auto mb-12"></div>
                <p id="modal-long-desc" class="font-serif text-xl md:text-2xl text-gray-300 leading-relaxed"></p>
                <div class="w-[1px] h-24 bg-gold-accent/50 mx-auto mt-12"></div>
            </div>
            
            <div class="px-4 md:px-24 max-w-[1920px] mx-auto">
                <div id="modal-gallery-grid" class="gallery-grid"></div>
            </div>
        </div>
    </div>

    <!-- LIGHTBOX -->
    <div id="lightbox">
        <div class="lightbox-close hover-trigger">
            <i data-lucide="x" class="w-10 h-10"></i>
        </div>
        <img id="lightbox-img" src="" alt="Full Screen View">
    </div>

    <!-- ABOUT SECTION -->
    <section id="about" class="relative py-32 bg-charcoal overflow-hidden border-t border-white/5">
        <div class="absolute top-1/2 left-0 w-full -translate-y-1/2 text-center pointer-events-none opacity-[0.02] z-0 select-none">
            <span class="vision-bg-text text-[25vw] font-display font-bold leading-none text-white tracking-tighter">VISION</span>
        </div>
    
        <div class="max-w-7xl mx-auto px-6 md:px-12 relative z-10">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 lg:gap-24 items-center">
                <div class="relative group perspective-container">
                    <div class="relative w-full aspect-[3/4] overflow-hidden rounded-sm border border-white/10 bg-void about-img-reveal opacity-0 translate-y-10">
                        <img src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?q=80&w=1200" alt="Artist Portrait" class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-1000 ease-out scale-100 group-hover:scale-105">
                        <div class="absolute inset-0 bg-gradient-to-t from-charcoal via-transparent to-transparent opacity-60"></div>
                    </div>
                </div>
    
                <div class="flex flex-col justify-center">
                    <div class="mb-8 about-text-reveal opacity-0 translate-y-10">
                        <span class="inline-block w-12 h-[1px] bg-gold-accent mb-1 align-middle mr-4"></span>
                        <span class="font-mono text-gold-accent text-xs tracking-widest uppercase">The Artist</span>
                    </div>
                    <h2 class="text-4xl md:text-6xl font-display text-white mb-8 leading-tight about-text-reveal opacity-0 translate-y-10">Crafting <span class="italic font-serif text-gold-accent">Silence</span> <br> in a Loud World.</h2>
                    <div class="space-y-6 about-text-reveal opacity-0 translate-y-10">
                        <p class="font-sans text-gray-300 leading-relaxed text-lg">"I don't just take photographs; I capture the feeling of a moment before it fades."</p>
                        <p class="font-sans text-gray-500 leading-relaxed text-sm">Based in Tokyo, working globally. Featured in major publications.</p>
                    </div>
    
                    <div class="mt-12 space-y-6 border-t border-white/10 pt-8 about-text-reveal opacity-0 translate-y-10">
                        <div class="flex justify-between items-center group cursor-pointer border-b border-transparent hover:border-white/10 pb-2 transition-colors">
                            <a href="#contact" class="text-roll hover-trigger block font-display text-xl text-white group-hover:text-gold-accent transition-colors" data-text="Trusted By Brands">Trusted By Brands</a>
                            <span class="font-mono text-xs text-gray-500">Worldwide</span>
                        </div>
                        <div class="flex justify-between items-center group cursor-pointer border-b border-transparent hover:border-white/10 pb-2 transition-colors">
                            <a href="#work" class="text-roll hover-trigger block font-display text-xl text-white group-hover:text-gold-accent transition-colors" data-text="Featured Editorially">Featured Editorially</a>
                            <span class="font-mono text-xs text-gray-500">Print & Digital</span>
                        </div>
                        <div class="flex justify-between items-center group cursor-pointer border-b border-transparent hover:border-white/10 pb-2 transition-colors">
                            <a href="#about" class="text-roll hover-trigger block font-display text-xl text-white group-hover:text-gold-accent transition-colors" data-text="Exhibited Globally">Exhibited Globally</a>
                            <span class="font-mono text-xs text-gray-500">Galleries</span>
                        </div>
                    </div>
                    <div class="mt-12 about-text-reveal opacity-0 translate-y-10">
                       <span class="font-serif italic text-4xl text-white/20 select-none">Lumos.</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- CONTACT SECTION -->
    <section id="contact" class="py-32 px-6 bg-charcoal relative">
        <div class="max-w-4xl mx-auto text-center">
            <p class="text-gold-accent font-sans tracking-[0.3em] text-xs mb-6">INQUIRIES</p>
            <h2 class="text-5xl md:text-7xl font-display mb-12 hover-trigger cursor-none">Let's Create <br> <span class="italic font-serif text-gray-500">Something Timeless</span></h2>
            
            <div class="flex flex-col items-center justify-center mt-16 space-y-12">
                <a href="mailto:hello@lumos.com" class="text-roll hover-trigger text-4xl md:text-7xl font-sans font-light lowercase text-white hover:text-gold-accent transition-colors leading-tight" data-text="hello@lumos.com">hello@lumos.com</a>
                
                <div class="flex gap-8 md:gap-16 font-sans text-sm tracking-widest text-gray-400">
                    <a href="#" class="text-roll hover-trigger py-2 border-b border-white/10 hover:border-gold-accent transition-colors" data-text="Instagram">Instagram</a>
                    <a href="#" class="text-roll hover-trigger py-2 border-b border-white/10 hover:border-gold-accent transition-colors" data-text="Behance">Behance</a>
                </div>
            </div>
            <footer class="mt-32 text-gray-600 text-xs font-sans tracking-wider">
                &copy; 2025 LUMOS PHOTOGRAPHY. ALL RIGHTS RESERVED.
            </footer>
        </div>
    </section>

    <script>
        // --- TEXT ROLL ---
        function setupTextRoll(element) {
            const originalText = element.getAttribute('data-text') || element.textContent.trim();
            const chars = originalText.split('');
            element.innerHTML = '';
            element.classList.add('group', 'inline-flex', 'overflow-hidden', 'relative');
            element.style.lineHeight = '1.2';
            chars.forEach((char, i) => {
                const wrapper = document.createElement('span');
                wrapper.className = 'relative inline-block overflow-hidden';
                wrapper.innerHTML = `<span class="inline-block transition-transform duration-500 ease-[cubic-bezier(0.16,1,0.3,1)] group-hover:-translate-y-full" style="transition-delay: ${i * 0.02}s">${char === ' ' ? '&nbsp;' : char}</span><span class="inline-block absolute top-0 left-0 transition-transform duration-500 ease-[cubic-bezier(0.16,1,0.3,1)] translate-y-full group-hover:translate-y-0 text-gold-accent" style="transition-delay: ${i * 0.02}s">${char === ' ' ? '&nbsp;' : char}</span>`;
                element.appendChild(wrapper);
            });
        }

        // --- MAIN APP LOGIC ---
        let mat4, vec3, vec2, quat;
        const discVertShaderSource = `#version 300 es
uniform mat4 uWorldMatrix; uniform mat4 uViewMatrix; uniform mat4 uProjectionMatrix; uniform vec3 uCameraPosition; uniform vec4 uRotationAxisVelocity; in vec3 aModelPosition; in vec3 aModelNormal; in vec2 aModelUvs; in mat4 aInstanceMatrix; out vec2 vUvs; out float vAlpha; flat out int vInstanceId; void main() { vec4 worldPosition = uWorldMatrix * aInstanceMatrix * vec4(aModelPosition, 1.); vec3 centerPos = (uWorldMatrix * aInstanceMatrix * vec4(0., 0., 0., 1.)).xyz; float radius = length(centerPos.xyz); if (gl_VertexID > 0) { vec3 rotationAxis = uRotationAxisVelocity.xyz; float rotationVelocity = min(.05, uRotationAxisVelocity.w * 4.0); vec3 stretchDir = normalize(cross(centerPos, rotationAxis)); vec3 relativeVertexPos = normalize(worldPosition.xyz - centerPos); float strength = dot(stretchDir, relativeVertexPos); float invAbsStrength = min(0., abs(strength) - 1.); strength = rotationVelocity * sign(strength) * abs(invAbsStrength * invAbsStrength * invAbsStrength + 1.); worldPosition.xyz += stretchDir * strength; } worldPosition.xyz = radius * normalize(worldPosition.xyz); gl_Position = uProjectionMatrix * uViewMatrix * worldPosition; vAlpha = smoothstep(0.5, 1., normalize(worldPosition.xyz).z) * .95 + .05; vUvs = aModelUvs; vInstanceId = gl_InstanceID; }`;
        const discFragShaderSource = `#version 300 es
precision highp float; uniform sampler2D uTex; uniform int uItemCount; uniform int uAtlasSize; out vec4 outColor; in vec2 vUvs; in float vAlpha; flat in int vInstanceId; void main() { int itemIndex = vInstanceId % uItemCount; int cellsPerRow = uAtlasSize; int cellX = itemIndex % cellsPerRow; int cellY = itemIndex / cellsPerRow; vec2 cellSize = vec2(1.0) / vec2(float(cellsPerRow)); vec2 cellOffset = vec2(float(cellX), float(cellY)) * cellSize; ivec2 texSize = textureSize(uTex, 0); float imageAspect = float(texSize.x) / float(texSize.y); float containerAspect = 1.0; float scale = max(imageAspect / containerAspect, containerAspect / imageAspect); vec2 st = vec2(vUvs.x, 1.0 - vUvs.y); st = (st - 0.5) * scale + 0.5; st = clamp(st, 0.0, 1.0); st = st * cellSize + cellOffset; outColor = texture(uTex, st); outColor.a *= vAlpha; }`;

        class Face { constructor(a, b, c) { this.a = a; this.b = b; this.c = c; } }
        class Vertex { constructor(x, y, z) { this.position = vec3.fromValues(x, y, z); this.normal = vec3.create(); this.uv = vec2.create(); } }
        class Geometry {
            constructor() { this.vertices = []; this.faces = []; }
            addVertex(...args) { for (let i = 0; i < args.length; i += 3) this.vertices.push(new Vertex(args[i], args[i + 1], args[i + 2])); return this; }
            addFace(...args) { for (let i = 0; i < args.length; i += 3) this.faces.push(new Face(args[i], args[i + 1], args[i + 2])); return this; }
            get lastVertex() { return this.vertices[this.vertices.length - 1]; }
            subdivide(divisions = 1) { const midPointCache = {}; let f = this.faces; for (let div = 0; div < divisions; ++div) { const newFaces = new Array(f.length * 4); f.forEach((face, ndx) => { const mAB = this.getMidPoint(face.a, face.b, midPointCache); const mBC = this.getMidPoint(face.b, face.c, midPointCache); const mCA = this.getMidPoint(face.c, face.a, midPointCache); const i = ndx * 4; newFaces[i + 0] = new Face(face.a, mAB, mCA); newFaces[i + 1] = new Face(face.b, mBC, mAB); newFaces[i + 2] = new Face(face.c, mCA, mBC); newFaces[i + 3] = new Face(mAB, mBC, mCA); }); f = newFaces; } this.faces = f; return this; }
            spherize(radius = 1) { this.vertices.forEach(vertex => { vec3.normalize(vertex.normal, vertex.position); vec3.scale(vertex.position, vertex.normal, radius); }); return this; }
            get data() { return { vertices: new Float32Array(this.vertices.flatMap(v => Array.from(v.position))), indices: new Uint16Array(this.faces.flatMap(f => [f.a, f.b, f.c])), normals: new Float32Array(this.vertices.flatMap(v => Array.from(v.normal))), uvs: new Float32Array(this.vertices.flatMap(v => Array.from(v.uv))) }; }
            getMidPoint(ndxA, ndxB, cache) { const cacheKey = ndxA < ndxB ? `k_${ndxB}_${ndxA}` : `k_${ndxA}_${ndxB}`; if (Object.prototype.hasOwnProperty.call(cache, cacheKey)) return cache[cacheKey]; const a = this.vertices[ndxA].position; const b = this.vertices[ndxB].position; const ndx = this.vertices.length; cache[cacheKey] = ndx; this.addVertex((a[0] + b[0]) * 0.5, (a[1] + b[1]) * 0.5, (a[2] + b[2]) * 0.5); return ndx; }
        }
        class IcosahedronGeometry extends Geometry { constructor() { super(); const t = Math.sqrt(5) * 0.5 + 0.5; this.addVertex(-1, t, 0, 1, t, 0, -1, -t, 0, 1, -t, 0, 0, -1, t, 0, 1, t, 0, -1, -t, 0, 1, -t, t, 0, -1, t, 0, 1, -t, 0, -1, -t, 0, 1).addFace(0, 11, 5, 0, 5, 1, 0, 1, 7, 0, 7, 10, 0, 10, 11, 1, 5, 9, 5, 11, 4, 11, 10, 2, 10, 7, 6, 7, 1, 8, 3, 9, 4, 3, 4, 2, 3, 2, 6, 3, 6, 8, 3, 8, 9, 4, 9, 5, 2, 4, 11, 6, 2, 10, 8, 6, 7, 9, 8, 1); } }
        class DiscGeometry extends Geometry { constructor(steps = 4, radius = 1) { super(); steps = Math.max(4, steps); const alpha = (2 * Math.PI) / steps; this.addVertex(0, 0, 0); this.lastVertex.uv[0] = 0.5; this.lastVertex.uv[1] = 0.5; for (let i = 0; i < steps; ++i) { const x = Math.cos(alpha * i); const y = Math.sin(alpha * i); this.addVertex(radius * x, radius * y, 0); this.lastVertex.uv[0] = x * 0.5 + 0.5; this.lastVertex.uv[1] = y * 0.5 + 0.5; if (i > 0) this.addFace(0, i, i + 1); } this.addFace(0, steps, 1); } }
        function createShader(gl, type, source) { const shader = gl.createShader(type); gl.shaderSource(shader, source); gl.compileShader(shader); if (gl.getShaderParameter(shader, gl.COMPILE_STATUS)) return shader; throw new Error(gl.getShaderInfoLog(shader)); }
        function createProgram(gl, shaderSources, attribLocations) { const program = gl.createProgram(); [gl.VERTEX_SHADER, gl.FRAGMENT_SHADER].forEach((type, ndx) => { const shader = createShader(gl, type, shaderSources[ndx]); if (shader) gl.attachShader(program, shader); }); if (attribLocations) { for (const attrib in attribLocations) gl.bindAttribLocation(program, attribLocations[attrib], attrib); } gl.linkProgram(program); if (gl.getProgramParameter(program, gl.LINK_STATUS)) return program; throw new Error(gl.getProgramInfoLog(program)); }
        function makeVertexArray(gl, bufLocNumElmPairs, indices) { const va = gl.createVertexArray(); gl.bindVertexArray(va); for (const [buffer, loc, numElem] of bufLocNumElmPairs) { if (loc === -1) continue; gl.bindBuffer(gl.ARRAY_BUFFER, buffer); gl.enableVertexAttribArray(loc); gl.vertexAttribPointer(loc, numElem, gl.FLOAT, false, 0, 0); } if (indices) { const indexBuffer = gl.createBuffer(); gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer); gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, indices, gl.STATIC_DRAW); } gl.bindVertexArray(null); return va; }
        function resizeCanvasToDisplaySize(canvas) { const dpr = Math.min(2, window.devicePixelRatio); const displayWidth = Math.round(canvas.clientWidth * dpr); const displayHeight = Math.round(canvas.clientHeight * dpr); if (canvas.width !== displayWidth || canvas.height !== displayHeight) { canvas.width = displayWidth; canvas.height = displayHeight; return true; } return false; }
        function makeBuffer(gl, sizeOrData, usage) { const buf = gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER, buf); gl.bufferData(gl.ARRAY_BUFFER, sizeOrData, usage); return buf; }

        class ArcballControl {
            constructor(canvas, updateCallback) { this.canvas = canvas; this.updateCallback = updateCallback || (() => null); this.isPointerDown = false; this.orientation = quat.create(); this.pointerRotation = quat.create(); this.rotationVelocity = 0; this.rotationAxis = vec3.fromValues(1, 0, 0); this.snapDirection = vec3.fromValues(0, 0, -1); this.pointerPos = vec2.create(); this.previousPointerPos = vec2.create(); this._rotationVelocity = 0; this._combinedQuat = quat.create(); this.EPSILON = 0.1; this.IDENTITY_QUAT = quat.create(); this.snapTargetDirection = null; canvas.addEventListener('pointerdown', e => { vec2.set(this.pointerPos, e.clientX, e.clientY); vec2.copy(this.previousPointerPos, this.pointerPos); this.isPointerDown = true; try{canvas.setPointerCapture(e.pointerId)}catch(e){} }); canvas.addEventListener('pointerup', e => { this.isPointerDown = false; try{canvas.releasePointerCapture(e.pointerId)}catch(e){} }); canvas.addEventListener('pointermove', e => { if (this.isPointerDown) vec2.set(this.pointerPos, e.clientX, e.clientY); }); canvas.style.touchAction = 'none'; }
            update(deltaTime, targetFrameDuration = 16) { const timeScale = deltaTime / targetFrameDuration + 0.00001; let angleFactor = timeScale; let snapRotation = quat.create(); if (this.isPointerDown) { const INTENSITY = 0.3 * timeScale; const ANGLE_AMPLIFICATION = 5 / timeScale; const midPointerPos = vec2.sub(vec2.create(), this.pointerPos, this.previousPointerPos); vec2.scale(midPointerPos, midPointerPos, INTENSITY); if (vec2.sqrLen(midPointerPos) > this.EPSILON) { vec2.add(midPointerPos, this.previousPointerPos, midPointerPos); const p = this._project(midPointerPos); const q = this._project(this.previousPointerPos); const a = vec3.normalize(vec3.create(), p); const b = vec3.normalize(vec3.create(), q); vec2.copy(this.previousPointerPos, midPointerPos); angleFactor *= ANGLE_AMPLIFICATION; this.quatFromVectors(a, b, this.pointerRotation, angleFactor); } else { quat.slerp(this.pointerRotation, this.pointerRotation, this.IDENTITY_QUAT, INTENSITY); } } else { const INTENSITY = 0.1 * timeScale; quat.slerp(this.pointerRotation, this.pointerRotation, this.IDENTITY_QUAT, INTENSITY); if (this.snapTargetDirection) { const SNAPPING_INTENSITY = 0.05; const a = this.snapTargetDirection; const b = this.snapDirection; const sqrDist = vec3.squaredDistance(a, b); const distanceFactor = Math.max(0.1, 1 - sqrDist * 10); angleFactor *= SNAPPING_INTENSITY * distanceFactor; this.quatFromVectors(a, b, snapRotation, angleFactor); } } const combinedQuat = quat.multiply(quat.create(), snapRotation, this.pointerRotation); this.orientation = quat.multiply(quat.create(), combinedQuat, this.orientation); quat.normalize(this.orientation, this.orientation); const rad = Math.acos(this._combinedQuat[3]) * 2.0; const s = Math.sin(rad / 2.0); let rv = 0; if (s > 0.000001) { rv = rad / (2 * Math.PI); this.rotationAxis[0] = this._combinedQuat[0] / s; this.rotationAxis[1] = this._combinedQuat[1] / s; this.rotationAxis[2] = this._combinedQuat[2] / s; } const RV_INTENSITY = 0.5 * timeScale; this._rotationVelocity += (rv - this._rotationVelocity) * RV_INTENSITY; this.rotationVelocity = this._rotationVelocity / timeScale; this.updateCallback(deltaTime); }
            quatFromVectors(a, b, out, angleFactor = 1) { const axis = vec3.cross(vec3.create(), a, b); vec3.normalize(axis, axis); const d = Math.max(-1, Math.min(1, vec3.dot(a, b))); const angle = Math.acos(d) * angleFactor; quat.setAxisAngle(out, axis, angle); }
            _project(pos) { const r = 2; const w = this.canvas.clientWidth; const h = this.canvas.clientHeight; const s = Math.max(w, h) - 1; const x = (2 * pos[0] - w - 1) / s; const y = (2 * pos[1] - h - 1) / s; const xySq = x * x + y * y; const rSq = r * r; let z = (xySq <= rSq / 2.0) ? Math.sqrt(rSq - xySq) : rSq / Math.sqrt(xySq); return vec3.fromValues(-x, y, z); }
        }

        class InfiniteGridMenu {
            constructor(canvas, items, onActiveItemChange, onMovementChange) { this.canvas = canvas; this.items = items || []; this.onActiveItemChange = onActiveItemChange; this.onMovementChange = onMovementChange; this.TARGET_FRAME_DURATION = 1000 / 60; this.SPHERE_RADIUS = 2; this._time = 0; this._deltaTime = 0; this._init(); }
            _init() {
                this.gl = this.canvas.getContext('webgl2', { antialias: true, alpha: false }); const gl = this.gl; if (!gl) throw new Error('WebGL 2 not supported.');
                this.camera = { matrix: mat4.create(), near: 0.1, far: 40, fov: Math.PI / 4, aspect: 1, position: vec3.fromValues(0, 0, 3), up: vec3.fromValues(0, 1, 0), matrices: { view: mat4.create(), projection: mat4.create(), inversProjection: mat4.create() } };
                this.discProgram = createProgram(gl, [discVertShaderSource, discFragShaderSource], { aModelPosition: 0, aModelNormal: 1, aModelUvs: 2, aInstanceMatrix: 3 });
                this.discLocations = { aModelPosition: gl.getAttribLocation(this.discProgram, 'aModelPosition'), aModelUvs: gl.getAttribLocation(this.discProgram, 'aModelUvs'), aInstanceMatrix: gl.getAttribLocation(this.discProgram, 'aInstanceMatrix'), uWorldMatrix: gl.getUniformLocation(this.discProgram, 'uWorldMatrix'), uViewMatrix: gl.getUniformLocation(this.discProgram, 'uViewMatrix'), uProjectionMatrix: gl.getUniformLocation(this.discProgram, 'uProjectionMatrix'), uCameraPosition: gl.getUniformLocation(this.discProgram, 'uCameraPosition'), uRotationAxisVelocity: gl.getUniformLocation(this.discProgram, 'uRotationAxisVelocity'), uTex: gl.getUniformLocation(this.discProgram, 'uTex'), uItemCount: gl.getUniformLocation(this.discProgram, 'uItemCount'), uAtlasSize: gl.getUniformLocation(this.discProgram, 'uAtlasSize') };
                this.discGeo = new DiscGeometry(56, 1); this.discBuffers = this.discGeo.data;
                this.discVAO = makeVertexArray(gl, [[makeBuffer(gl, this.discBuffers.vertices, gl.STATIC_DRAW), this.discLocations.aModelPosition, 3], [makeBuffer(gl, this.discBuffers.uvs, gl.STATIC_DRAW), this.discLocations.aModelUvs, 2]], this.discBuffers.indices);
                this.icoGeo = new IcosahedronGeometry(); this.icoGeo.subdivide(1).spherize(this.SPHERE_RADIUS);
                this.instancePositions = this.icoGeo.vertices.map(v => v.position); this.DISC_INSTANCE_COUNT = this.icoGeo.vertices.length;
                this._initDiscInstances(this.DISC_INSTANCE_COUNT); this.worldMatrix = mat4.create(); this._initTexture();
                this.control = new ArcballControl(this.canvas, deltaTime => this._onControlUpdate(deltaTime)); this.resize(); this.run();
            }
            _initTexture() {
                const gl = this.gl; this.tex = gl.createTexture(); gl.bindTexture(gl.TEXTURE_2D, this.tex);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE); gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST); gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
                const pixel = new Uint8Array([212, 175, 55, 255]); gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE, pixel);
                const itemCount = Math.max(1, this.items.length); this.atlasSize = Math.ceil(Math.sqrt(itemCount));
                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const cellSize = 512;
                canvas.width = this.atlasSize * cellSize; canvas.height = this.atlasSize * cellSize;
                let imagesLoaded = 0;
                const checkLoad = () => { imagesLoaded++; if (imagesLoaded === this.items.length) { gl.bindTexture(gl.TEXTURE_2D, this.tex); gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, canvas); gl.generateMipmap(gl.TEXTURE_2D); gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR); gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR); if(document.getElementById('menu-title')) document.getElementById('menu-title').innerText = "DRAG TO EXPLORE"; } }
                this.items.forEach((item, i) => {
                    // Calculate position
                    const x = (i % this.atlasSize) * cellSize; 
                    const y = Math.floor(i / this.atlasSize) * cellSize;

                    // 3rd Sphere (index 2) - Solid Color override
                    if (i === 2) {
                        ctx.fillStyle = "#dfdfdf";
                        ctx.fillRect(x, y, cellSize, cellSize);
                        checkLoad();
                        return;
                    }

                    const img = new Image(); img.crossOrigin = 'anonymous';
                    img.onload = () => {
                         ctx.fillStyle = "#151515"; ctx.fillRect(x, y, cellSize, cellSize);
                         const aspect = img.width / img.height; let drawW = cellSize, drawH = cellSize; let offX = 0, offY = 0;
                         if (aspect > 1) { drawW = cellSize * aspect; offX = -(drawW - cellSize) / 2; } else { drawH = cellSize / aspect; offY = -(drawH - cellSize) / 2; }
                         ctx.drawImage(img, x + offX, y + offY, drawW, drawH); checkLoad();
                    }; img.onerror = checkLoad; img.src = item.image;
                });
            }
            _initDiscInstances(count) {
                const gl = this.gl; this.discInstances = { matricesArray: new Float32Array(count * 16), matrices: [], buffer: gl.createBuffer() };
                for (let i = 0; i < count; ++i) { const instanceMatrixArray = new Float32Array(this.discInstances.matricesArray.buffer, i * 16 * 4, 16); instanceMatrixArray.set(mat4.create()); this.discInstances.matrices.push(instanceMatrixArray); }
                gl.bindVertexArray(this.discVAO); gl.bindBuffer(gl.ARRAY_BUFFER, this.discInstances.buffer); gl.bufferData(gl.ARRAY_BUFFER, this.discInstances.matricesArray.byteLength, gl.DYNAMIC_DRAW);
                const bytesPerMatrix = 64; for (let j = 0; j < 4; ++j) { const loc = this.discLocations.aInstanceMatrix + j; gl.enableVertexAttribArray(loc); gl.vertexAttribPointer(loc, 4, gl.FLOAT, false, bytesPerMatrix, j * 16); gl.vertexAttribDivisor(loc, 1); } gl.bindBuffer(gl.ARRAY_BUFFER, null); gl.bindVertexArray(null);
            }
            resize() {
                const gl = this.gl; if (resizeCanvasToDisplaySize(gl.canvas)) gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
                const aspect = gl.canvas.clientWidth / gl.canvas.clientHeight; const height = this.SPHERE_RADIUS * 0.35; const distance = this.camera.position[2];
                if (aspect > 1) this.camera.fov = 2 * Math.atan(height / distance); else this.camera.fov = 2 * Math.atan(height / aspect / distance);
                mat4.perspective(this.camera.matrices.projection, this.camera.fov, aspect, this.camera.near, this.camera.far);
            }
            _animate(deltaTime) {
                const gl = this.gl; this.control.update(deltaTime, this.TARGET_FRAME_DURATION);
                let positions = this.instancePositions.map(p => vec3.transformQuat(vec3.create(), p, this.control.orientation));
                const scale = 0.25; const SCALE_INTENSITY = 0.6;
                positions.forEach((p, ndx) => {
                    const s = (Math.abs(p[2]) / this.SPHERE_RADIUS) * SCALE_INTENSITY + (1 - SCALE_INTENSITY); const finalScale = s * scale;
                    const matrix = mat4.create();
                    mat4.multiply(matrix, matrix, mat4.fromTranslation(mat4.create(), vec3.negate(vec3.create(), p)));
                    mat4.multiply(matrix, matrix, mat4.targetTo(mat4.create(), [0, 0, 0], p, [0, 1, 0]));
                    mat4.multiply(matrix, matrix, mat4.fromScaling(mat4.create(), [finalScale, finalScale, finalScale]));
                    mat4.multiply(matrix, matrix, mat4.fromTranslation(mat4.create(), [0, 0, -this.SPHERE_RADIUS]));
                    mat4.copy(this.discInstances.matrices[ndx], matrix);
                });
                gl.bindBuffer(gl.ARRAY_BUFFER, this.discInstances.buffer); gl.bufferSubData(gl.ARRAY_BUFFER, 0, this.discInstances.matricesArray);
                gl.bindBuffer(gl.ARRAY_BUFFER, null); this.smoothRotationVelocity = this.control.rotationVelocity;
            }
            _render() {
                const gl = this.gl; gl.useProgram(this.discProgram); gl.enable(gl.CULL_FACE); gl.enable(gl.DEPTH_TEST);
                gl.clearColor(0, 0, 0, 0); gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                mat4.targetTo(this.camera.matrix, this.camera.position, [0, 0, 0], this.camera.up); mat4.invert(this.camera.matrices.view, this.camera.matrix);
                gl.uniformMatrix4fv(this.discLocations.uWorldMatrix, false, this.worldMatrix); gl.uniformMatrix4fv(this.discLocations.uViewMatrix, false, this.camera.matrices.view);
                gl.uniformMatrix4fv(this.discLocations.uProjectionMatrix, false, this.camera.matrices.projection);
                gl.uniform3f(this.discLocations.uCameraPosition, this.camera.position[0], this.camera.position[1], this.camera.position[2]);
                gl.uniform4f(this.discLocations.uRotationAxisVelocity, this.control.rotationAxis[0], this.control.rotationAxis[1], this.control.rotationAxis[2], this.smoothRotationVelocity * 1.1);
                gl.uniform1i(this.discLocations.uItemCount, this.items.length); gl.uniform1i(this.discLocations.uAtlasSize, this.atlasSize);
                gl.activeTexture(gl.TEXTURE0); gl.bindTexture(gl.TEXTURE_2D, this.tex); gl.bindVertexArray(this.discVAO);
                gl.drawElementsInstanced(gl.TRIANGLES, this.discBuffers.indices.length, gl.UNSIGNED_SHORT, 0, this.DISC_INSTANCE_COUNT);
            }
            _onControlUpdate(deltaTime) {
                const timeScale = deltaTime / this.TARGET_FRAME_DURATION + 0.0001; let damping = 5 / timeScale; let cameraTargetZ = 3;
                const isMoving = this.control.isPointerDown || Math.abs(this.smoothRotationVelocity) > 0.01;
                if (isMoving !== this.movementActive) { this.movementActive = isMoving; this.onMovementChange(isMoving); }
                if (!this.control.isPointerDown) {
                    const nearestVertexIndex = this._findNearestVertexIndex(); const itemIndex = nearestVertexIndex % Math.max(1, this.items.length);
                    this.onActiveItemChange(itemIndex); const snapDirection = vec3.normalize(vec3.create(), this._getVertexWorldPosition(nearestVertexIndex));
                    this.control.snapTargetDirection = snapDirection;
                } else { cameraTargetZ += this.control.rotationVelocity * 80 + 0.5; damping = 7 / timeScale; }
                this.camera.position[2] += (cameraTargetZ - this.camera.position[2]) / damping;
            }
            _findNearestVertexIndex() {
                const n = this.control.snapDirection; const inversOrientation = quat.conjugate(quat.create(), this.control.orientation);
                const nt = vec3.transformQuat(vec3.create(), n, inversOrientation);
                let maxD = -1; let nearestVertexIndex;
                for (let i = 0; i < this.instancePositions.length; ++i) { const d = vec3.dot(nt, this.instancePositions[i]); if (d > maxD) { maxD = d; nearestVertexIndex = i; } }
                return nearestVertexIndex;
            }
            _getVertexWorldPosition(index) {
                const nearestVertexPos = this.instancePositions[index]; return vec3.transformQuat(vec3.create(), nearestVertexPos, this.control.orientation);
            }
            run(time = 0) {
                this._deltaTime = Math.min(32, time - this._time); this._time = time; this._animate(this._deltaTime); this._render(); requestAnimationFrame(t => this.run(t));
            }
        }

        // --- DATA: PROJECTS ---
        const projectsData = [
            { 
                title: "Ethereal Muse", desc: "Portraiture Series",
                longDesc: "A deep dive into the vulnerability of the human form. This series explores how natural light interacts with skin textures and emotional expressions, creating a narrative that feels both intimate and universally resonant. Each session was conducted in available light to preserve authenticity.",
                cover: "https://images.unsplash.com/photo-1493863641943-9b68992a8d07?q=80&w=600",
                gallery: [
                    "https://images.unsplash.com/photo-1534528741775-53994a69daeb?q=80&w=1200",
                    "https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?q=80&w=1200",
                    "https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=1200",
                    "https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?q=80&w=1200",
                    "https://images.unsplash.com/photo-1500917293891-ef795e70e1f6?q=80&w=1200",
                    "https://images.unsplash.com/photo-1494790108377-be9c29b29330?q=80&w=1200"
                ]
            },
            { 
                title: "Urban Silence", desc: "Architecture",
                longDesc: "Capturing the quiet moments in a city that never sleeps. This collection focuses on the geometry of modern architecture, finding stillness in concrete and steel structures during the early morning hours. The goal was to strip away the chaos and reveal the skeletal beauty of the metropolis.",
                cover: "https://images.unsplash.com/photo-1515523110800-9415d13b84a8?q=80&w=600",
                gallery: [
                    "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=800",
                    "https://images.unsplash.com/photo-1516035069371-29a1b244cc32?q=80&w=800",
                    "https://images.unsplash.com/photo-1480714378408-67cf0d13bc1b?q=80&w=800",
                      "https://images.unsplash.com/photo-1511818966892-d7d671e672a2?q=80&w=800",
                      "https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?q=80&w=800",
                      "https://images.unsplash.com/photo-1479839672679-a46483c0e7c8?q=80&w=800"
                ]
            },
            { 
                title: "Raw Nature", desc: "Landscape",
                longDesc: "An ode to the untamed wilderness. From misty mountains to roaring coastlines, these images attempt to capture the overwhelming scale and raw beauty of the natural world in its purest form. Shot across diverse climates, this series emphasizes texture and atmosphere.",
                cover: "https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?q=80&w=600",
                gallery: [
                    "https://images.unsplash.com/photo-1500917293891-ef795e70e1f6?q=80&w=800",
                    "https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?q=80&w=800",
                    "https://images.unsplash.com/photo-1501854140884-074cf2b2c344?q=80&w=800",
                    "https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=800",
                      "https://images.unsplash.com/photo-1433086966358-54859d0ed716?q=80&w=800",
                      "https://images.unsplash.com/photo-1465146344425-f00d5f5c8f07?q=80&w=800"
                ]
            },
            { 
                title: "Neon Noir", desc: "Night City",
                longDesc: "The city comes alive at night in a wash of neon and rain. This series is a cinematic exploration of urban nightlife, inspired by cyberpunk aesthetics and film noir lighting techniques.",
                cover: "https://images.unsplash.com/photo-1555212697-194d092e3b8f?q=80&w=600",
                gallery: [
                    "https://images.unsplash.com/photo-1565626424177-86c4626c256f?q=80&w=800",
                    "https://images.unsplash.com/photo-1572061486656-d1728c74f629?q=80&w=800",
                    "https://images.unsplash.com/photo-1584351582873-38617962048e?q=80&w=800",
                    "https://images.unsplash.com/photo-1517639493569-5666a780fd6a?q=80&w=800",
                    "https://images.unsplash.com/photo-1545959560-68c59740fd8d?q=80&w=800",
                    "https://images.unsplash.com/photo-1494587416117-f102a2ac0f69?q=80&w=800"
                ]
            },
             { 
                title: "Studio Abstract", desc: "Fine Art",
                longDesc: "Breaking away from reality to explore form, color, and composition. These studio works use unconventional objects and lighting to create abstract visual narratives that challenge perception.",
                cover: "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=600",
                gallery: [
                    "https://images.unsplash.com/photo-1509909756405-478fac943a61?q=80&w=800",
                    "https://images.unsplash.com/photo-1558591710-4b4a1ae0f04d?q=80&w=800",
                    "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=800",
                    "https://images.unsplash.com/photo-1513569143478-959193e295a9?q=80&w=800",
                    "https://images.unsplash.com/photo-1578321272176-b7bbc0679853?q=80&w=800",
                    "https://images.unsplash.com/photo-1541963463532-d68292c34b19?q=80&w=800"
                ]
            },
             { 
                title: "Golden Hour", desc: "Warmth",
                longDesc: "Chasing the last light of the day. This series documents the magic that happens in the golden hour, where shadows lengthen and the world is bathed in a warm, nostalgic glow.",
                cover: "https://images.unsplash.com/photo-1480714378408-67cf0d13bc1b?q=80&w=600",
                gallery: [
                    "https://images.unsplash.com/photo-1480714378408-67cf0d13bc1b?q=80&w=800",
                    "https://images.unsplash.com/photo-1502982720700-bfff97f2ecac?q=80&w=800",
                      "https://images.unsplash.com/photo-1499678329028-101435549a4e?q=80&w=800",
                    "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=800",
                    "https://images.unsplash.com/photo-1469334031218-e382a71b716b?q=80&w=800",
                    "https://images.unsplash.com/photo-1421930866250-aa0594cea05c?q=80&w=800"
                ]
            },
             { 
                title: "Silent Peaks", desc: "Alpine",
                longDesc: "High altitude photography exploring the solitude of mountain ranges. The stark contrast between rock, snow, and sky creates a minimalist canvas for nature's grandeur.",
                cover: "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=600",
                gallery: [
                    "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=800", 
                    "https://images.unsplash.com/photo-1483728642387-6c3bdd6c93e5?q=80&w=800",
                    "https://images.unsplash.com/photo-1486870591958-9b9d0d1dda99?q=80&w=800",
                    "https://images.unsplash.com/photo-1454496522488-7a8e488e8606?q=80&w=800",
                    "https://images.unsplash.com/photo-1519681393798-38e032215731?q=80&w=800",
                    "https://images.unsplash.com/photo-1517330357046-3ab5a5dd42a1?q=80&w=800"
                ]
            },
            { 
                title: "Ocean Fury", desc: "Seascape",
                longDesc: "The raw power of the ocean captured during winter storms. These images freeze the chaotic energy of waves crashing against the shore, highlighting the relentless force of the sea.",
                cover: "https://images.unsplash.com/photo-1505118380757-91f5f5632de0?q=80&w=600",
                gallery: [
                    "https://images.unsplash.com/photo-1505118380757-91f5f5632de0?q=80&w=800", 
                    "https://images.unsplash.com/photo-1518837695005-2083093ee35b?q=80&w=800",
                    "https://images.unsplash.com/photo-1484291470158-b8f8d608850d?q=80&w=800",
                    "https://images.unsplash.com/photo-1520942702018-086521279b54?q=80&w=800",
                    "https://images.unsplash.com/photo-1513553404607-988bf2703777?q=80&w=800",
                    "https://images.unsplash.com/photo-1536760140623-4a8c0330b962?q=80&w=800"
                ]
            },
            { 
                title: "Urban Decay", desc: "Documentary",
                longDesc: "Documenting the beauty in abandoned structures and forgotten places. This series explores the concept of transience, showing how nature reclaims what humanity leaves behind.",
                cover: "https://images.unsplash.com/photo-1477414348463-c0eb7f1359b6?q=80&w=600",
                gallery: [
                    "https://images.unsplash.com/photo-1477414348463-c0eb7f1359b6?q=80&w=800", 
                    "https://images.unsplash.com/photo-1444723121867-7a241cacace9?q=80&w=800",
                    "https://images.unsplash.com/photo-1506784365847-bbad939e9335?q=80&w=800",
                    "https://images.unsplash.com/photo-1481277542470-605612bd2d61?q=80&w=800",
                    "https://images.unsplash.com/photo-1528722828814-77b9b8a90203?q=80&w=800",
                    "https://images.unsplash.com/photo-1518644730709-0835105d9daa?q=80&w=800"
                ]
            }
        ];

        // --- MASONRY RENDERER ---
        function initMasonryGrid() {
            const container = document.getElementById('projects-masonry');
            if(!container) return;
            container.innerHTML = '';

            projectsData.forEach((project, i) => {
                const card = document.createElement('div');
                card.className = 'masonry-item group hover-trigger';
                card.innerHTML = `
                    <div class="relative overflow-hidden rounded-sm border border-white/5 bg-charcoal">
                        <img src="${project.cover}" alt="${project.title}" class="transition-transform duration-1000 group-hover:scale-105">
                        <div class="masonry-overlay">
                            <div class="overlay-title">
                                <p class="font-mono text-gold-accent text-xs tracking-widest mb-2">0${i+1}</p>
                                <h3 class="font-display text-white text-2xl leading-none mb-1">${project.title}</h3>
                                <p class="font-serif text-gray-400 text-sm italic">${project.desc}</p>
                            </div>
                        </div>
                    </div>
                `;
                
                card.addEventListener('click', () => openProjectModal(project));
                container.appendChild(card);

                gsap.to(card, {
                    y: 0, opacity: 1, duration: 1, delay: i * 0.1, ease: "power3.out",
                    scrollTrigger: { trigger: card, start: "top 90%" }
                });
            });
        }

        // --- MODAL LOGIC ---
        function openProjectModal(project) {
            const modal = document.getElementById('project-modal');
            const heroImg = document.getElementById('modal-hero-img');
            const title = document.getElementById('modal-title');
            const subtitle = document.getElementById('modal-subtitle');
            const longDesc = document.getElementById('modal-long-desc');
            const grid = document.getElementById('modal-gallery-grid');

            heroImg.src = project.cover;
            title.innerText = project.title;
            subtitle.innerText = project.desc;
            longDesc.innerText = project.longDesc || "Visual exploration.";
            
            grid.innerHTML = '';
            
            // Add All Images to Vertical Grid
            const allImages = [...project.gallery];
            
            allImages.forEach((src, i) => {
                const div = document.createElement('div');
                const aspectClass = i % 3 === 0 ? "col-span-1 md:col-span-2 aspect-[16/9]" : "col-span-1 aspect-[3/4]";
                div.className = `w-full ${aspectClass} overflow-hidden rounded-sm opacity-0 translate-y-10 gallery-item-anim bg-charcoal mb-8 border border-white/5 group cursor-zoom-in`;
                div.innerHTML = `
                    <img src="${src}" class="w-full h-full object-cover hover:scale-105 transition-transform duration-1000">
                    <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                        <i data-lucide="maximize-2" class="text-white w-8 h-8 opacity-80"></i>
                    </div>
                `;
                div.onclick = () => openLightbox(src);
                grid.appendChild(div);
            });

            lucide.createIcons();
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            modal.scrollTop = 0;

            gsap.fromTo(heroImg, {scale: 1.1}, {scale: 1, duration: 1.5, ease: "power3.out"});
            gsap.fromTo([title, subtitle], {y: 50, opacity: 0}, {y: 0, opacity: 1, duration: 1, stagger: 0.1, delay: 0.2, ease: "power3.out"});
            gsap.fromTo(longDesc, {y: 30, opacity: 0}, {y: 0, opacity: 1, duration: 1, delay: 0.4, ease: "power3.out"});
            const items = document.querySelectorAll('.gallery-item-anim');
            gsap.to(items, { y: 0, opacity: 1, duration: 0.8, stagger: 0.1, delay: 0.5, ease: "power3.out" });
        }

        document.querySelector('.modal-close-btn').addEventListener('click', () => {
            document.getElementById('project-modal').classList.remove('active');
            document.body.style.overflow = ''; 
        });

        // --- LIGHTBOX LOGIC ---
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const lightboxClose = document.querySelector('.lightbox-close');
        function openLightbox(src) { lightboxImg.src = src; lightbox.classList.add('active'); }
        function closeLightbox() { lightbox.classList.remove('active'); }
        if (lightbox) { 
            lightboxClose.addEventListener('click', closeLightbox); 
            lightbox.addEventListener('click', (e) => { if(e.target === lightbox) closeLightbox(); }); 
        }

        // --- MAIN INIT ---
        window.addEventListener('load', () => {
            const lenis = new Lenis({ duration: 1.2, easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)), direction: 'vertical', gestureDirection: 'vertical', smooth: true, mouseMultiplier: 1, smoothTouch: false, touchMultiplier: 2 });
            function raf(time) { lenis.raf(time); requestAnimationFrame(raf); } requestAnimationFrame(raf);
            setTimeout(() => { const loader = document.getElementById('loader'); if (loader && loader.style.height !== '0px') { gsap.to('#loader', { height: 0, duration: 1, ease: "expo.inOut", onComplete: () => { document.getElementById('loader').style.display = 'none'; }}); } }, 3000);
            const tl = gsap.timeline(); tl.to('.loader-text span', { y: 0, opacity: 1, duration: 0.8, stagger: 0.1, ease: "power3.out" }).to('.loader-text span', { y: -20, opacity: 0, duration: 0.5, stagger: 0.05, ease: "power3.in", delay: 0.5 }).to('#loader', { height: 0, duration: 1, ease: "expo.inOut", onComplete: () => { document.getElementById('loader').style.display = 'none'; }});
            
            try {
                const cursorDot = document.getElementById('cursor-dot'); const cursorOutline = document.getElementById('cursor-outline');
                const xTo = gsap.quickTo(cursorOutline, "x", {duration: 0.5, ease: "power3"});
                const yTo = gsap.quickTo(cursorOutline, "y", {duration: 0.5, ease: "power3"});
                window.addEventListener('mousemove', (e) => {
                    gsap.set(cursorDot, {x: e.clientX, y: e.clientY});
                    xTo(e.clientX);
                    yTo(e.clientY);
                });

                document.querySelectorAll('.hover-trigger').forEach(el => { el.addEventListener('mouseenter', () => document.body.classList.add('hovering')); el.addEventListener('mouseleave', () => document.body.classList.remove('hovering')); });
                document.querySelectorAll('.text-roll').forEach(el => setupTextRoll(el));

                gsap.registerPlugin(ScrollTrigger);
                const revealTl = gsap.timeline({ scrollTrigger: { trigger: "#transition-text", start: "top 60%", end: "bottom bottom" } });
                revealTl.to(".reveal-text", { y: 0, opacity: 1, duration: 1.2, stagger: 0.2, ease: "power4.out" }).to(".reveal-sub", { opacity: 1, duration: 1, ease: "power2.out" }, "-=0.8");

                const gallery = document.getElementById('parallax-gallery');
                if (gallery) {
                    gsap.to("#gallery-fade-layer", { opacity: 1, ease: "none", scrollTrigger: { trigger: gallery, start: "center center", end: "bottom top", scrub: 0.5 } });
                    document.querySelectorAll('.parallax-col').forEach((col, i) => { const offset = parseFloat(col.getAttribute('data-offset')); gsap.from(col, { yPercent: offset, ease: "none", scrollTrigger: { trigger: gallery, start: "top bottom", end: "center center", scrub: 0.5 } }); });
                }
                
                // INIT MASONRY GRID
                initMasonryGrid();

                // About Section Anims
                const aboutSection = document.getElementById('about');
                if (aboutSection) {
                    const tl = gsap.timeline({ scrollTrigger: { trigger: aboutSection, start: "top 70%", end: "bottom bottom", toggleActions: "play none none reverse" } });
                    tl.to(".about-img-reveal", { y: 0, opacity: 1, duration: 1.2, ease: "power3.out" }).to(".about-text-reveal", { y: 0, opacity: 1, duration: 0.8, stagger: 0.1, ease: "power2.out" }, "-=0.5");
                    // Fixed selector
                    gsap.to(".vision-bg-text", { y: 100, ease: "none", scrollTrigger: { trigger: aboutSection, start: "top bottom", end: "bottom top", scrub: true } });
                }

            } catch(e) { console.error("Init Error:", e); }

            // 3. WEBGL MENU
            try {
                if (typeof glMatrix === 'undefined') throw new Error("3D Library (gl-matrix) failed to load.");
                mat4 = glMatrix.mat4; vec3 = glMatrix.vec3; vec2 = glMatrix.vec2; quat = glMatrix.quat;
                const portfolioItems = [ { image: 'https://images.unsplash.com/photo-1500917293891-ef795e70e1f6?w=800&q=80', title: 'Solitude', description: 'Fashion Editorial' }, { image: 'https://images.unsplash.com/photo-1493863641943-9b68992a8d07?w=800&q=80', title: 'Persona', description: 'Portraiture' }, { image: 'https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=800&q=80', title: 'Wildlands', description: 'Landscape' }, { image: 'https://images.unsplash.com/photo-1515523110800-9415d13b84a8?w=800&q=80', title: 'Structure', description: 'Architecture' }, { image: 'https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=800&q=80', title: 'Neon', description: 'Night City' }, { image: 'https://images.unsplash.com/photo-1615715757401-f30e7b27b912?w=800&q=80', title: 'Textures', description: 'Fine Art' }, { image: 'https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?w=800&q=80', title: 'Elegance', description: 'Wedding' }, { image: 'https://images.unsplash.com/photo-1502982720700-bfff97f2ecac?w=800&q=80', title: 'Film', description: 'Analog' }, { image: 'https://images.unsplash.com/photo-1542038784456-1ea8e935640e?w=800&q=80', title: 'Focus', description: 'Macro' }, { image: 'https://images.unsplash.com/photo-1516035069371-29a1b244cc32?w=800&q=80', title: 'Motion', description: 'Street' }, { image: 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=800&q=80', title: 'Visage', description: 'Studio' }, { image: 'https://images.unsplash.com/photo-1551316679-9c6ae9dec224?w=800&q=80', title: 'Minimal', description: 'Design' } ];
                const canvas = document.getElementById('infinite-grid-menu-canvas');
                const titleEl = document.getElementById('menu-title'); const descEl = document.getElementById('menu-desc'); const btnEl = document.getElementById('menu-btn');
                const updateUI = (index) => { const item = portfolioItems[index]; if(item && titleEl.innerText !== item.title) { titleEl.innerText = item.title; descEl.innerText = item.description; } };
                const updateMovement = (isMoving) => { const elems = [titleEl, descEl, btnEl]; elems.forEach(el => { if (isMoving) { el.classList.add('inactive'); el.classList.remove('active'); } else { el.classList.remove('inactive'); el.classList.add('active'); } }); };
                if (canvas) { const menu = new InfiniteGridMenu(canvas, portfolioItems, updateUI, updateMovement); window.addEventListener('resize', () => menu.resize()); }
                btnEl.addEventListener('click', () => { document.getElementById('transition-text').scrollIntoView({ behavior: 'smooth' }); });
            } catch(e) { console.error("WebGL/Menu Initialization Failed:", e); const errBox = document.getElementById('webgl-error'); if(errBox) { errBox.innerText = "Experience Unavailable: " + e.message; errBox.style.display = 'block'; } const titleEl = document.getElementById('menu-title'); if(titleEl) titleEl.innerText = "LUMOS"; }
        });
    </script>
</body>
</html>